services:
  postgres:
    image: postgres:16-alpine
    container_name: soil_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: soil_watering
      POSTGRES_USER: soil_user
      POSTGRES_PASSWORD: secure_password_123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soil_user -d soil_watering"]
      interval: 10s
      timeout: 5s
      retries: 5
    
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: msqto
    restart: unless-stopped
    ports:
    - "1883:1883"
    - "8883:8883"
    volumes:
    - ./mosquitto/config:/mosquitto/config
    - mosquitto_data:/mosquitto/data
    - mosquitto_log:/mosquitto_log
    - ./certs:/mosquitto/certs:ro
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3


volumes:
  postgres_data:
  mosquitto_data:
  mosquitto_log: